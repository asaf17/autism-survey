<html>
<head>
	<script>
		//Subtract a set of arbitrary score valules from 6. 
		function scorefrom6(scores, indices) {
			for(var i = 0; i < indices.length; i++) {
				if(indices[i] >= scores.length) continue; 
				scores[indices[i]] = 6 - scores[indices[i]]; 
			}
			return scores; 
		}

		//Take a sum over a contiguous range of indices of scores. 
		function sumoverindices(scores, a, b) {
			if(b < a) { //Ensure a < b. 
				var tmp = b; 
				b = a; 
				a = tmp; 
			}
			var s = 0; 
			for(var i = a; i <= b && i < scores.length; i++) { //Take sum over the specified range of indices. 
				s += scores[i]; 
			}
			return s; 
		}

		//Ensure that the vector of scores is compliant with the needed formatting. 
		function validatescores(scores, requiredlength, minscore, maxscore) {
			//Ensure correct length of score vector. 
			while(scores.length < requiredlength) scores.push(minscore); 
			while(scores.length > requiredlength) scores.pop(); 
			//Verify that each score is in the range 1 to 5. 
			for(var i = 0; i < scores.length; i++) {
				if(scores < minscore) {
					scores = minscore; 
				} else if(scores > maxscore) {
					scores = maxscore; 
				}
			}
			return scores; 
		}

		//Compute the CFQL2 autism quality of life score. Translated from a spreadsheet (16 Sept. '21). 
		//All sub-scores are to be stored in the database. 
		//Basics of reports should look like the spreadsheets (spatially, in terms of layout and content), interpretation. 
		function cfql2(scores, print) {
			//Ensure scores vector is conforming. 
			scores = validatescores(scores, 26, 1, 5); 
			//Transform scores (subtract some from 6). 
			scores = scorefrom6(scores, [1,3,4,5,6,7,8,9,11,12,13,14,15,17,18,22,23,24,25]); 
			//Determine qol scores for each of these parameters. 
			var childqol = sumoverindices(scores, 0, 3); 
			var childpossible = 20; 
			var familyqol = sumoverindices(scores, 4, 7); 
			var familypossible = 20; 
			var caregiverqol = sumoverindices(scores, 8, 11); 
			var caregiverpossible = 20; 
			var financialqol = sumoverindices(scores, 12, 14); 
			var financialpossible = 15; 
			var socialqol = sumoverindices(scores, 15, 18); 
			var socialpossible = 20; 
			var relationshipqol = sumoverindices(scores, 19, 22); 
			var relationshippossible = 20; 
			var copingqol = sumoverindices(scores, 23, 25); 
			var copingpossible = 15; 
			var changescale = scores[3]+scores[7]+scores[11]+scores[14]+scores[18]+scores[22]+scores[25];
			var changescalepossible = 35; 
			//Penultimate step. 
			var rawtotal = childqol + familyqol + caregiverqol + financialqol + socialqol + relationshipqol + copingqol; 
			var totalpossible = childpossible+ familypossible + caregiverpossible + financialpossible + socialpossible + relationshippossible + copingpossible;
			//Final computation. 
			var averageitemtotal = 5.0 * rawtotal / totalpossible; 
			//Yield. 
			return averageitemtotal; //AN: Could also append other measures here as a string. 
		}
		
		//Compute ASDQ scoring, translated from spreadsheet (23 Sept. '21). 
		function asdq(scores, print) {
			//Ensure scores vector is conforming. 
			scores = validatescores(scores, 39, 1, 5); 
			//Transform scores (subtract some from 6). 
			scores = scorefrom6(scores, [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]); 
			//Begin determining scores, all are essentially averages. 
			var asdtotal = sumoverindices(scores, 0, 35) / 36.0; 
			//alert(scores + "  - " + asdtotal); 
			//"Domains". 
			var sci = sumoverindices(0, 17) / 18.0; 
			var rrb = sumoverindices(17, 35) / 19.0; 
			//"Social sub-scales". 
			var ssb_socialmotivation = sumoverindices(0, 2) / 3.0; 
			var ssb_nonverbalcommunication = sumoverindices(3, 5) / 3.0; 
			var ssb_reciprocity = sumoverindices(6, 10) / 5.0; 
			var ssb_perspectivetaking = sumoverindices(11, 13) / 3.0; 
			var ssb_relationships = sumoverindices(14, 16) / 3.0; 
			//"Repetitive sub-scales". 
			var rsb_repetitivebehavior = sumoverindices(19, 21) / 3.0; 
			var rsb_needforsamaeness = sumoverindices(21, 24) / 4.0; 
			var rsb_sensorysensitivity = sumoverindices(25, 27) / 3.0; 
			var rsb_sensoryinterests = sumoverindices(28, 30) / 3.0; 
			var rsb_restrictedinterests = sumoverindices(30, 36) / 7.0; 
			//Yield. 
			return asdtotal; 
		}
		
		//"Driver" functions that performs the tests. 
		function run_cfql2() {
			var content =  document.getElementById("content"); 
			//content.textContent = "adsfasdfs"; 
			content.textContent=""+cfql2([3,3,4,3,5,3,3,3,3,1,3,3,3,3,4,3,3,3,3,3,3,3,3,3,3,5], false); 
		}
		//Ditto. 
		function run_asdq() {
			var content =  document.getElementById("content"); 
			//content.textContent = "adsfasdfs"; 
			content.textContent=""+asdq([3,4,2,3,5,1,2,4,5,5,3,4,1,4,5,1,3,5,1,3,4,2,3,3,1,4,5,1,3,4,3,1,2,3,3,4,5,4,5], false); 
		}

		//Request a pristine data set and hand-computed correct output from the client at next meeting, to help verify these. 
	</script>
</head>
<body>
	<main>
		<span id="content">test</span>
		<form><input type = "button" value = "CFQL2" onclick = "run_cfql2();" /></form>
		<form><input type = "button" value = "ASDQ" onclick = "run_asdq();" /></form>
	</main>
</body>
</html>